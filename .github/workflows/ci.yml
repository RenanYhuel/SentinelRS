name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always
    RUSTFLAGS: "-D warnings"

jobs:
    fmt:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
            - run: cargo fmt --all -- --check

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        needs: fmt
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy
            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-clippy-
            - run: cargo clippy --workspace --all-targets -- -D warnings

    test:
        name: Tests
        runs-on: ubuntu-latest
        needs: clippy
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-test-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-test-
            - run: cargo test --workspace

    build:
        name: Build (${{ matrix.target }})
        runs-on: ${{ matrix.os }}
        needs: test
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      suffix: ""
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      suffix: ".exe"
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      suffix: ""
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}
            - name: Install system dependencies
              shell: bash
              run: |
                  if [ "$RUNNER_OS" = "Linux" ]; then
                    sudo apt-get update && sudo apt-get install -y protobuf-compiler libssl-dev pkg-config
                  elif [ "$RUNNER_OS" = "macOS" ]; then
                    brew install protobuf
                  elif [ "$RUNNER_OS" = "Windows" ]; then
                    choco install protoc -y
                  fi
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-build-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-build-${{ matrix.target }}-
            - run: cargo build --release --target ${{ matrix.target }}
            - name: Package binaries (Linux/macOS)
              if: runner.os != 'Windows'
              run: |
                  mkdir -p dist
                  cp target/${{ matrix.target }}/release/sentinel_agent dist/ || true
                  cp target/${{ matrix.target }}/release/sentinel_server dist/ || true
                  cp target/${{ matrix.target }}/release/sentinel_workers dist/ || true
                  cp target/${{ matrix.target }}/release/sentinel_cli dist/ || true
                  tar -czf sentinel-${{ matrix.target }}.tar.gz -C dist .
            - name: Package binaries (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  New-Item -ItemType Directory -Force -Path dist
                  Copy-Item target/${{ matrix.target }}/release/sentinel_agent.exe dist/ -ErrorAction SilentlyContinue
                  Copy-Item target/${{ matrix.target }}/release/sentinel_server.exe dist/ -ErrorAction SilentlyContinue
                  Copy-Item target/${{ matrix.target }}/release/sentinel_workers.exe dist/ -ErrorAction SilentlyContinue
                  Copy-Item target/${{ matrix.target }}/release/sentinel_cli.exe dist/ -ErrorAction SilentlyContinue
                  Compress-Archive -Path dist/* -DestinationPath sentinel-${{ matrix.target }}.zip
            - uses: actions/upload-artifact@v4
              with:
                  name: sentinel-${{ matrix.target }}
                  path: sentinel-${{ matrix.target }}.*

    integration-smoke:
        name: Integration Smoke
        runs-on: ubuntu-latest
        needs: test
        services:
            nats:
                image: nats:2.10-alpine
                ports:
                    - 14222:4222
                options: >-
                    --health-cmd "nc -z localhost 4222 || exit 1"
                    --health-interval 3s
                    --health-timeout 3s
                    --health-retries 10
            timescaledb:
                image: timescale/timescaledb:latest-pg14
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: sentinel_e2e
                ports:
                    - 15432:5432
                options: >-
                    --health-cmd "pg_isready -U postgres"
                    --health-interval 5s
                    --health-timeout 3s
                    --health-retries 10
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-smoke-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-smoke-
            - run: cargo build --release
            - name: Run integration smoke tests
              env:
                  NATS_URL: nats://localhost:14222
                  DATABASE_URL: postgres://postgres:postgres@localhost:15432/sentinel_e2e
              run: cargo test --workspace --test '*' -- --ignored --test-threads=1 || true
