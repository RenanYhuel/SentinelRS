name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always
    RUSTFLAGS: "-D warnings"

jobs:
    fmt:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
            - run: cargo fmt --all -- --check

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        needs: fmt
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy
            - uses: arduino/setup-protoc@v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-clippy-
            - run: cargo clippy --workspace --all-targets -- -D warnings

    test:
        name: Tests
        runs-on: ubuntu-latest
        needs: clippy
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: arduino/setup-protoc@v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-test-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-test-
            - run: cargo test --workspace

    build:
        name: Build (${{ matrix.target }})
        runs-on: ${{ matrix.os }}
        needs: test
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      suffix: ""
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      suffix: ".exe"
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      suffix: ""
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}
            - uses: arduino/setup-protoc@v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-build-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-build-${{ matrix.target }}-
            - run: cargo build --release --target ${{ matrix.target }}
            - uses: actions/upload-artifact@v4
              with:
                  name: binaries-${{ matrix.target }}
                  path: |
                      target/${{ matrix.target }}/release/sentinel_agent${{ matrix.suffix }}
                      target/${{ matrix.target }}/release/sentinel_server${{ matrix.suffix }}
                      target/${{ matrix.target }}/release/sentinel_workers${{ matrix.suffix }}
                      target/${{ matrix.target }}/release/sentinel_cli${{ matrix.suffix }}

    integration-smoke:
        name: Integration Smoke
        runs-on: ubuntu-latest
        needs: test
        services:
            nats:
                image: nats:2.9.4
                ports:
                    - 14222:4222
                    - 18222:8222
                options: >-
                    --health-cmd "wget -qO- http://localhost:8222/healthz || exit 1"
                    --health-interval 5s
                    --health-timeout 3s
                    --health-retries 10
            timescaledb:
                image: timescale/timescaledb:latest-pg14
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: sentinel_e2e
                ports:
                    - 15432:5432
                options: >-
                    --health-cmd "pg_isready -U postgres"
                    --health-interval 5s
                    --health-timeout 3s
                    --health-retries 10
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: arduino/setup-protoc@v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-smoke-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-smoke-
            - run: cargo build --release
            - name: Run integration smoke tests
              env:
                  NATS_URL: nats://localhost:14222
                  DATABASE_URL: postgres://postgres:postgres@localhost:15432/sentinel_e2e
              run: cargo test --workspace --test '*' -- --ignored || true
